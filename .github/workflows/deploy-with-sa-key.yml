name: Deploy to Cloud Run (Service Account Key)

# This workflow uses service account key authentication as an alternative to Workload Identity Federation
# To use this workflow:
# 1. Create a service account key and add it to GitHub Secrets as GCP_SA_KEY
# 2. Rename or disable the main deploy.yml workflow
# 3. Enable this workflow
# See DEPLOYMENT_SETUP.md for detailed instructions

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: gen-lang-client-0765258695

      - name: Deploy to Cloud Run from source
        run: |
          gcloud run deploy vibe-check-backend \
            --source . \
            --region us-east4 \
            --allow-unauthenticated

      # ---- OR ----
      # Option B: Build a container image and deploy it (uncomment if you prefer Docker)
      # - name: Configure Docker auth for Artifact Registry
      #   run: gcloud auth configure-docker us-east4-docker.pkg.dev --quiet
      #
      # - name: Build & push image
      #   run: |
      #     SHORT_SHA=$(git rev-parse --short HEAD)
      #     IMAGE="us-east4-docker.pkg.dev/gen-lang-client-0765258695/vibecheck-registry/vibe-check-backend:${SHORT_SHA}"
      #     docker build -t "$IMAGE" .
      #     docker push "$IMAGE"
      #
      # - name: Deploy image
      #   run: |
      #     gcloud run deploy vibe-check-backend \
      #       --image "$IMAGE" \
      #       --region us-east4 \
      #       --allow-unauthenticated
